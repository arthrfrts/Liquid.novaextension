<!doctype html>
<html lang="{{- page.lang | default: site.lang -}}">
  <head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<title>{%- if page.title -%}{{ page.title }} — {% endif %} {{ site.title }}</title>
	{% seo title=false %}

	<link rel="stylesheet" href="{% link /assets/css/base.css %}" />
	<link rel="stylesheet" href="{% link /assets/css/layout.css %}" />
	<link rel="stylesheet" href="{%- link /assets/css/fonts.css -%}" />

      {% feed_meta %}
	{% json_feed_meta %}

    <style>
      body {
        color: {{ page.colors.fg }};
      }
    </style>
  </head>
  <body>
	<div class="hug" data-liquid="{{ value.object | strip }}">
        <header class="site-header">
          {% if page.title %}
            <h3 class="site-title">
            <a href="{{ '/' | absolute_url }}">{{ site.title }}</a>
            </h3>
          {% else %}
            <h1 class="site-title">
            <a href="{{ '/' | absolute_url }}">{{ site.title }}</a>
            </h1>
          {% endif %}

          {% if site.nav %}
            <nav class="site-menu">
              {% for path in site.nav %}
                {% assign nav_page = site.pages | where: "path", path | first %}

                <a
                  class="menu-item {% if page.url == nav_page.url %}_current{% endif %}"
                  href="{{ nav_page.url | relative_url }}"
                >
                  {{ nav_page.title }}

                </a>
              {% endfor %}
            </nav>
          {% endif %}
        </header>
        <main class="site-content">
          <!-- Complex conditional logic with elsif and multiple conditions -->
          {% if page.layout == 'post' and page.featured %}
            <div class="featured-banner">
              <span class="featured-label">Featured Post</span>
              {% if page.featured_image %}
                <img src="{{ page.featured_image | relative_url }}" alt="{{ page.title }}" />
              {% endif %}
            </div>
          {% elsif page.layout == 'post' %}
            <div class="post-meta">
              <time datetime="{{ page.date | date_to_xmlschema }}">
                {{ page.date | date: "%B %d, %Y" }}
              </time>
              {% if page.author %}
                by <span class="author">{{ page.author }}</span>
              {% endif %}
            </div>
          {% elsif page.layout == 'page' and page.show_toc %}
            <div class="table-of-contents">
              <h2>Table of Contents</h2>
              <!-- This would typically be generated by a plugin -->
            </div>
          {% endif %}

          <!-- Case statement for different content types -->
          {% case page.type %}
            {% when 'article' %}
              <article class="content-article">
                {{ content }}
                {% if page.tags and page.tags != empty %}
                  <div class="tags">
                    {% for tag in page.tags %}
                      <span class="tag">{{ tag | slugify }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
              </article>
            {% when 'gallery' %}
              <div class="gallery-container">
                {% for image in page.images %}
                  <figure class="gallery-item">
                    <img src="{{ image.url | relative_url }}" alt="{{ image.alt | default: 'Gallery image' }}" />
                    {% if image.caption %}
                      <figcaption>{{ image.caption | markdownify | strip_html }}</figcaption>
                    {% endif %}
                  </figure>
                {% endfor %}
              </div>
            {% when 'product' %}
              <div class="product-details">
                <h2>{{ page.product_name | default: page.title }}</h2>
                <div class="price">
                  {% if page.sale_price %}
                    <span class="original-price">${{ page.original_price | money_without_currency }}</span>
                    <span class="sale-price">${{ page.sale_price | money_without_currency }}</span>
                  {% else %}
                    <span class="price">${{ page.price | money_without_currency }}</span>
                  {% endif %}
                </div>
                {{ content }}
              </div>
            {% else %}
              <div class="default-content">
                {{ content }}
              </div>
          {% endcase %}

          <!-- Complex loop with filtering and sorting -->
          {% assign related_posts = site.posts | where_exp: "post", "post.categories contains page.primary_category" | sort: "date" | reverse | limit: 3 %}
          {% if related_posts and related_posts != empty %}
            <section class="related-posts">
              <h3>Related Posts</h3>
              {% for post in related_posts %}
                {% unless post.url == page.url %}
                  <article class="related-post">
                    <h4><a href="{{ post.url | relative_url }}">{{ post.title }}</a></h4>
                    <p>{{ post.excerpt | strip_html | truncatewords: 20 }}</p>
                    <time>{{ post.date | date: "%b %d, %Y" }}</time>
                  </article>
                {% endunless %}
              {% endfor %}
            </section>
          {% endif %}

          <!-- Advanced data manipulation with capture and assign -->
          {% capture page_word_count %}{{ content | number_of_words }}{% endcapture %}
          {% assign reading_time = page_word_count | divided_by: 200 | plus: 1 %}
          {% if reading_time > 1 %}
            <div class="reading-time">
              Estimated reading time: {{ reading_time }} minutes
            </div>
          {% endif %}

          <!-- Nested loops with complex conditions -->
          {% if site.data.testimonials %}
            <section class="testimonials">
              <h3>What Our Customers Say</h3>
              {% for testimonial in site.data.testimonials %}
                {% if testimonial.featured or forloop.index <= 3 %}
                  <blockquote class="testimonial {% if testimonial.featured %}featured{% endif %}">
                    <p>{{ testimonial.quote | markdownify }}</p>
                    <cite>
                      {{ testimonial.author }}
                      {% if testimonial.company %}
                        , {{ testimonial.company }}
                      {% endif %}
                      {% if testimonial.rating %}
                        <span class="rating">
                          {% for i in (1..5) %}
                            {% if i <= testimonial.rating %}★{% else %}☆{% endif %}
                          {% endfor %}
                        </span>
                      {% endif %}
                    </cite>
                  </blockquote>
                {% endif %}
              {% endfor %}
            </section>
          {% endif %}
        </main>

        {% include footer.html %}
      </div>

      <script>
        console.debug("Last built {{ 'now' | date_to_xmlschema }}");
        
        // Complex Liquid logic in JavaScript
        {% if site.analytics_id %}
          // Analytics tracking
          gtag('config', '{{ site.analytics_id }}', {
            page_title: '{{ page.title | escape }}',
            page_location: '{{ page.url | absolute_url }}',
            {% if page.categories.size > 0 %}
            custom_map: {
              category: '{{ page.categories | first | escape }}'
            }
            {% endif %}
          });
        {% endif %}

        // Dynamic feature flags
        const features = {
          {% for feature in site.data.features %}
            {{ feature.name }}: {{ feature.enabled | jsonify }}{% unless forloop.last %},{% endunless %}
          {% endfor %}
        };

        // Conditional script loading
        {% case page.layout %}
          {% when 'gallery' %}
            // Load gallery scripts
            if (typeof lightbox === 'undefined') {
              const script = document.createElement('script');
              script.src = '{{ "/assets/js/lightbox.js" | relative_url }}';
              document.head.appendChild(script);
            }
          {% when 'contact' %}
            // Load form validation
            document.addEventListener('DOMContentLoaded', function() {
              const form = document.querySelector('#contact-form');
              if (form) {
                form.addEventListener('submit', validateForm);
              }
            });
        {% endcase %}

        // Environment-specific code
        {% if jekyll.environment == 'development' %}
          console.log('Development mode active');
          window.DEBUG = true;
        {% else %}
          // Production optimizations
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('{{ "/sw.js" | relative_url }}');
          }
        {% endif %}
      </script>
  </body>
</html>
